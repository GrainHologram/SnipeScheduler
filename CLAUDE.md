# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SnipeScheduler is a PHP/MySQL web app that adds equipment reservation and checkout workflows on top of **Snipe-IT**. It communicates exclusively through the Snipe-IT REST API (never touches the Snipe-IT database directly). Authentication is via LDAP, Google OAuth, or Microsoft Entra OAuth — there is no local user signup.

## Architecture

### Directory Layout
- **`public/`** — Web root (Apache/Nginx should point here). Contains all user-facing PHP pages, the installer, and static assets (`assets/style.css`, `assets/nav.js`).
- **`src/`** — Shared backend modules, included by pages in `public/` and `scripts/`.
- **`config/`** — Runtime config (`config.php`, generated by installer or copied from `config.example.php`). Also holds `cache/` for API response caching.
- **`scripts/`** — CLI/cron scripts (not web-accessible).

### Key Source Modules (`src/`)
- **`bootstrap.php`** — Defines `APP_ROOT`, `SRC_PATH`, `CONFIG_PATH`; loads config loader and datetime helpers; sets PHP to UTC.
- **`config_loader.php`** — `load_config()` returns the config array (static-cached). Searches `config/config.php` then legacy root path.
- **`db.php`** — Creates `$pdo` (PDO connection to the booking database). Include this file to get the connection.
- **`snipeit_client.php`** — All Snipe-IT API interaction. Core function `snipeit_request()` handles HTTP, caching, and error handling. Higher-level functions for models, assets, users, checkout/checkin, groups, certifications.
- **`auth.php`** — Session-based auth guard. Include at top of protected pages. Exposes `$currentUser` and the `h()` HTML-escape helper.
- **`layout.php`** — Shared UI: nav rendering, theme/color CSS variables, logo, footer. Provides `layout_status_badge()` for rendering reservation status badges.
- **`checkout_rules.php`** — Policy enforcement: checkout duration limits, renewal limits, certification requirements, single-active-checkout rule. Limits are per-group with most-permissive-wins logic. Duration limits are enforced at reservation creation time (basket), not during staff checkout.
- **`booking_helpers.php`** — Reservation item fetching and summary text building.
- **`datetime_helpers.php`** — Timezone conversion, configurable date/time formatting. Three timezone contexts: PHP internally runs in UTC, `app_tz` for display, `snipe_tz` for Snipe-IT server dates.
- **`activity_log.php`** — Audit logging to `activity_log` table.

### Timezone Model
PHP's default timezone is forced to **UTC** in `bootstrap.php`. All DB datetimes are stored in UTC. Two configurable timezones exist:
- **App timezone** (`config['app']['timezone']`) — used for display to users.
- **Snipe-IT timezone** (`config['snipeit']['timezone']`) — used when reading/writing dates from/to the Snipe-IT API. Falls back to app timezone if empty.

Always convert at boundaries: use `app_format_date_local()` / `app_format_datetime_local()` for display, and convert to `snipe_tz` before sending to the Snipe-IT API.

### Database
The app owns its own MySQL database (separate from Snipe-IT). Key tables:
- `reservations` — booking records with status enum: `pending`, `confirmed`, `fulfilled`, `cancelled`, `missed`.
- `reservation_items` — models + quantities per reservation (FK to reservations). Has `deleted_at` for soft-delete.
- `checkouts` — physical checkout sessions with status enum: `open`, `partial`, `closed`. Links to reservation via `reservation_id`.
- `checkout_items` — per-asset rows for each checkout. Has `checked_in_at` to track returns.
- `checked_out_asset_cache` — local cache of Snipe-IT checked-out assets, populated by cron.
- `activity_log` — audit trail.
- `users` — local user records.
- `schema_version` — tracks applied migrations.

Schema lives in `public/install/schema.sql`. Upgrades in `public/install/upgrade/`.

### Reservation Lifecycle
Reservations track booking intent (scheduling). Status progression:

```
pending → confirmed → fulfilled | cancelled | missed
```

- **`pending`** — user has submitted a reservation request.
- **`confirmed`** — staff has confirmed/approved the reservation.
- **`fulfilled`** — all non-deleted items have been checked out. A `checkouts` record exists with the physical asset tracking.
- **`cancelled`** — reservation was cancelled before checkout.
- **`missed`** — reservation was not collected within the missed cutoff window (only `pending`/`confirmed` reservations can be marked missed by `cron_mark_missed.php`).

**Active vs finished:** Availability queries treat `pending` and `confirmed` reservations as capacity-reserving. Active checkouts (`checkout_items` with `checked_in_at IS NULL`) also reserve capacity, queried separately from the `checkouts`/`checkout_items` tables. `fulfilled`, `cancelled`, and `missed` are terminal for reservations. Deletion is blocked for `fulfilled` reservations (configurable via `reservations.deletable_statuses`).

### Checkout Lifecycle
Checkouts track physical asset possession (who has what). Status progression:

```
open → partial → closed
```

- **`open`** — assets actively out with user, none returned yet.
- **`partial`** — some `checkout_items` have `checked_in_at` set.
- **`closed`** — all `checkout_items` have `checked_in_at` set (all assets returned).

Each checkout has a `reservation_id` (nullable for walk-up checkouts) and per-asset `checkout_items` rows. The `checked_out_asset_cache` table remains as a Snipe-IT sync cache; `checkout_items` is the authoritative local checkout record. The sync cron reconciles `checkout_items` against the cache to detect returns made directly in Snipe-IT.

### Snipe-IT API Integration
- All API calls go through `snipeit_request()` in `snipeit_client.php`.
- GET responses are cached to `config/cache/` with configurable TTL (`api_cache_ttl_seconds`).
- Assets/models must have `requestable` flag set in Snipe-IT to appear in the catalogue.
- The `checked_out_asset_cache` table avoids hitting the API on every page load — it's refreshed by the `sync_checked_out_assets.php` cron script.
- Snipe-IT checkout/checkin endpoints (`POST /hardware/{id}/checkout` and `/checkin`) ignore custom fields. Custom field values must be set/cleared via a separate `PUT /hardware/{id}` call after checkout/checkin. See `checkout_asset_to_user()` and `checkin_asset()` in `snipeit_client.php`.
- To get assets assigned to a specific user, use `GET /users/{id}/assets` (via `get_assets_checked_out_to_user()`). Do NOT use `GET /hardware?assigned_to=` — that parameter does not filter correctly and returns all assets.

### Authentication & Authorization
- Three auth providers: LDAP, Google OAuth, Microsoft Entra. At least one must be configured.
- Staff/admin roles are determined by LDAP group CN or email lists in config (`admin_group_cn`, `checkout_group_cn`, `google_admin_emails`, etc.).
- `$currentUser` session data drives role checks throughout the app.

### Access Group Requirement
Users must belong to at least one Snipe-IT group matching the pattern `Access - *` (e.g., "Access - Lab Equipment", "Access - Studio") to make reservations. This is a global gate enforced in `catalogue.php`, `basket.php`, and `basket_checkout.php` via `check_user_has_access_group()` in `checkout_rules.php`. It is separate from per-model `Cert - *` certification requirements. No staff/admin exemption — all users must have an Access group.

### Quick Checkin User Detection
`public/quick_checkin.php` supports a "detected user" workflow for bulk check-ins. When staff scans the first asset, if that asset is checked out to a user, the page:
- Stores the detected user in `$_SESSION['quick_checkin_detected_user']` (id, name, email).
- Fetches all of that user's checked-out assets via `get_assets_checked_out_to_user()` and stores them in `$_SESSION['quick_checkin_user_assets']`.
- Displays a panel showing the user's full checkout list. Assets already in the checkin list are highlighted green; others have an "Add" button.
- The detected user is **locked** to the first scanned user — scanning assets from other users does not change the panel.
- Both session keys are cleared after successful checkin or manual list clear.

### Cron Scripts (`scripts/`)
- `sync_checked_out_assets.php` — Syncs checked-out assets from Snipe-IT API to local cache. Also reconciles `checkout_items` against the cache — if an asset is no longer checked out in Snipe-IT, its `checked_in_at` is set and the parent checkout status is recomputed. Should run frequently (e.g., every minute).
- `cron_mark_missed.php` — Marks uncollected `pending`/`confirmed` reservations as missed after configurable cutoff.
- `email_overdue_staff.php` / `email_overdue_users.php` — Overdue notification emails.

## Development Notes

- **No build step or package manager** — plain PHP, no Composer dependencies, no bundler. Just edit and reload.
- **No test suite** — there are no automated tests in this codebase.
- **Config file is gitignored** — `config.php` contains secrets. Use `config.example.php` as reference.
- **`snipeit_db.php` is legacy** — contains hardcoded credentials for direct Snipe-IT DB access. The app no longer uses this; all access goes through the API via `snipeit_client.php`.
- Global variables are used extensively (`$pdo`, `$snipeBaseUrl`, `$snipeApiToken`, etc. via `global`).
- The `h()` function (defined in `auth.php`) is the standard HTML-escape helper used across all pages.
- Images from Snipe-IT are delivered through `public/image_proxy.php` to avoid exposing the Snipe-IT server to end users.
- Snipe-IT assets have `last_checkout` (datetime), `last_checkin` (datetime), and `expected_checkin` (date) fields. Snipe-IT logging will log a datetime supplied to `expected_checkin`, but will truncate to a date on storage. All asset API calls should continue to supply a datetime to `expected_checkin`.


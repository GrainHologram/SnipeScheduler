# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SnipeScheduler is a PHP/MySQL web app that adds equipment reservation and checkout workflows on top of **Snipe-IT**. It communicates exclusively through the Snipe-IT REST API (never touches the Snipe-IT database directly). Authentication is via LDAP, Google OAuth, or Microsoft Entra OAuth — there is no local user signup.

## Architecture

### Directory Layout
- **`public/`** — Web root (Apache/Nginx should point here). Contains all user-facing PHP pages, the installer, and static assets (`assets/style.css`, `assets/nav.js`).
- **`src/`** — Shared backend modules, included by pages in `public/` and `scripts/`.
- **`config/`** — Runtime config (`config.php`, generated by installer or copied from `config.example.php`). Also holds `cache/` for API response caching.
- **`scripts/`** — CLI/cron scripts (not web-accessible).

### Key Source Modules (`src/`)
- **`bootstrap.php`** — Defines `APP_ROOT`, `SRC_PATH`, `CONFIG_PATH`; loads config loader and datetime helpers; sets PHP to UTC.
- **`config_loader.php`** — `load_config()` returns the config array (static-cached). Searches `config/config.php` then legacy root path.
- **`db.php`** — Creates `$pdo` (PDO connection to the booking database). Include this file to get the connection.
- **`snipeit_client.php`** — All Snipe-IT API interaction. Core function `snipeit_request()` handles HTTP, caching, and error handling. Higher-level functions for models, assets, users, checkout/checkin, groups, certifications.
- **`auth.php`** — Session-based auth guard. Include at top of protected pages. Exposes `$currentUser` and the `h()` HTML-escape helper.
- **`layout.php`** — Shared UI: nav rendering, theme/color CSS variables, logo, footer. Provides `layout_status_badge()` for rendering reservation status badges.
- **`checkout_rules.php`** — Policy enforcement: checkout duration limits, renewal limits, certification requirements, single-active-checkout rule. Limits are per-group with most-permissive-wins logic. Duration limits are enforced at reservation creation time (basket), not during staff checkout.
- **`booking_helpers.php`** — Reservation item fetching and summary text building.
- **`datetime_helpers.php`** — Timezone conversion, configurable date/time formatting. Three timezone contexts: PHP internally runs in UTC, `app_tz` for display, `snipe_tz` for Snipe-IT server dates.
- **`activity_log.php`** — Audit logging to `activity_log` table.

### Timezone Model
PHP's default timezone is forced to **UTC** in `bootstrap.php`. All DB datetimes are stored in UTC. Two configurable timezones exist:
- **App timezone** (`config['app']['timezone']`) — used for display to users.
- **Snipe-IT timezone** (`config['snipeit']['timezone']`) — used when reading/writing dates from/to the Snipe-IT API. Falls back to app timezone if empty.

Always convert at boundaries: use `app_format_date_local()` / `app_format_datetime_local()` for display, and convert to `snipe_tz` before sending to the Snipe-IT API.

### Database
The app owns its own MySQL database (separate from Snipe-IT). Key tables:
- `reservations` — booking records with status enum: `pending`, `confirmed`, `checked_out`, `completed`, `cancelled`, `missed`.
- `reservation_items` — models + quantities per reservation (FK to reservations).
- `checked_out_asset_cache` — local cache of Snipe-IT checked-out assets, populated by cron.
- `activity_log` — audit trail.
- `users` — local user records.
- `schema_version` — tracks applied migrations.

Schema lives in `public/install/schema.sql`. Upgrades in `public/install/upgrade/`.

### Reservation Lifecycle
Reservations follow this status progression:

```
pending → confirmed → checked_out → completed
                ↘                        ↗
              (missed / cancelled)
```

- **`pending`** — user has submitted a reservation request.
- **`confirmed`** — staff has confirmed/approved the reservation.
- **`checked_out`** — staff has checked out assets to the user via `staff_checkout.php`. The reservation is actively held — assets are with the user.
- **`completed`** — all assets have been returned (checked in). Transition happens automatically via the `sync_checked_out_assets.php` cron script when none of the reservation's assets remain in the checked-out cache.
- **`cancelled`** — reservation was cancelled before checkout.
- **`missed`** — reservation was not collected within the missed cutoff window (only `pending`/`confirmed` reservations can be marked missed by `cron_mark_missed.php`).

**Active vs finished:** Availability queries treat `pending`, `confirmed`, and `checked_out` as "active" statuses that reserve equipment capacity. `completed`, `cancelled`, and `missed` are terminal — they release capacity. Deletion and cancellation are blocked for `checked_out` reservations (configurable via `reservations.deletable_statuses`).

### Snipe-IT API Integration
- All API calls go through `snipeit_request()` in `snipeit_client.php`.
- GET responses are cached to `config/cache/` with configurable TTL (`api_cache_ttl_seconds`).
- Assets/models must have `requestable` flag set in Snipe-IT to appear in the catalogue.
- The `checked_out_asset_cache` table avoids hitting the API on every page load — it's refreshed by the `sync_checked_out_assets.php` cron script.
- Snipe-IT checkout/checkin endpoints (`POST /hardware/{id}/checkout` and `/checkin`) ignore custom fields. Custom field values must be set/cleared via a separate `PUT /hardware/{id}` call after checkout/checkin. See `checkout_asset_to_user()` and `checkin_asset()` in `snipeit_client.php`.

### Authentication & Authorization
- Three auth providers: LDAP, Google OAuth, Microsoft Entra. At least one must be configured.
- Staff/admin roles are determined by LDAP group CN or email lists in config (`admin_group_cn`, `checkout_group_cn`, `google_admin_emails`, etc.).
- `$currentUser` session data drives role checks throughout the app.

### Cron Scripts (`scripts/`)
- `sync_checked_out_assets.php` — Syncs checked-out assets from Snipe-IT API to local cache. Also transitions `checked_out` reservations to `completed` when all their assets have been returned. Should run frequently (e.g., every minute).
- `cron_mark_missed.php` — Marks uncollected `pending`/`confirmed` reservations as missed after configurable cutoff. Does not affect `checked_out` reservations.
- `email_overdue_staff.php` / `email_overdue_users.php` — Overdue notification emails.

## Development Notes

- **No build step or package manager** — plain PHP, no Composer dependencies, no bundler. Just edit and reload.
- **No test suite** — there are no automated tests in this codebase.
- **Config file is gitignored** — `config.php` contains secrets. Use `config.example.php` as reference.
- **`snipeit_db.php` is legacy** — contains hardcoded credentials for direct Snipe-IT DB access. The app no longer uses this; all access goes through the API via `snipeit_client.php`.
- Global variables are used extensively (`$pdo`, `$snipeBaseUrl`, `$snipeApiToken`, etc. via `global`).
- The `h()` function (defined in `auth.php`) is the standard HTML-escape helper used across all pages.
- Images from Snipe-IT are delivered through `public/image_proxy.php` to avoid exposing the Snipe-IT server to end users.
- Snipe-IT assets have `last_checkout` (datetime), `last_checkin` (datetime), and `expected_checkin` (date) fields. Snipe-IT logging will log a datetime supplied to `expected_checkin`, but will truncate to a date on storage. All asset API calls should continue to supply a datetime to `expected_checkin`.

